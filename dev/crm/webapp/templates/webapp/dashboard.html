{% extends 'webapp/base.html' %}

{% block content %}
<div class="container py-4">

    <h3 class="mb-4">Welcome, {{ user.username }}! ðŸ‘‹</h3>

    <!-- RECORD SECTION -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Customers</h5>
            <a class="btn btn-outline-primary btn-sm" href="{% url 'create-record' %}">
                + New Customer
            </a>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Address</th>
                            <th>City</th>
                            <th>Province</th>
                            <th>Country</th>
                            <th>Joined</th>
                            <th>Created By</th>
                            <th>View</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in records %}
                        <tr>
                            <td>{{ record.id }}</td>
                            <td>{{ record.first_name }} {{ record.last_name }}</td>
                            <td>{{ record.email }}</td>
                            <td>{{ record.phone }}</td>
                            <td>{{ record.address }}</td>
                            <td>{{ record.city }}</td>
                            <td>{{ record.province }}</td>
                            <td>{{ record.country }}</td>
                            <td>{{ record.creation_date }}</td>
                            <td>{{ record.created_by }}</td>
                            <td>
                                <a class="btn btn-success btn-sm" href="{% url 'record' record.id %}">
                                    <i class="fa fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
<div class="card-footer">
    <nav>
        <ul class="pagination justify-content-center">
            {% if records.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?record_page={{ records.previous_page_number }}">Previous</a>
                </li>
            {% endif %}
            <li class="page-item disabled">
                <span class="page-link">Page {{ records.number }} of {{ records.paginator.num_pages }}</span>
            </li>
            {% if records.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?record_page={{ records.next_page_number }}">Next</a>
                </li>
            {% endif %}
        </ul>
    </nav>
</div>

    <!-- LEADS SECTION -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Leads</h5>
            <a class="btn btn-outline-primary btn-sm" href="{% url 'create-lead' %}">
                + New Lead
            </a>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Customer</th>
                            <th>Status</th>
                            <th>Note</th>
                            <th>Created At</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lead in leads %}
                        <tr>
                            <td>{{ lead.id }}</td>
                            <td>{{ lead.customer.first_name }} {{ lead.customer.last_name }}</td>
                            <td>{{ lead.status }}</td>
                            <td>{{ lead.note }}</td>
                            <td>{{ lead.created_at }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
<div class="card-footer">
    <nav>
        <ul class="pagination justify-content-center">
            {% if leads.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?lead_page={{ leads.previous_page_number }}">Previous</a>
                </li>
            {% endif %}
            <li class="page-item disabled">
                <span class="page-link">Page {{ leads.number }} of {{ leads.paginator.num_pages }}</span>
            </li>
            {% if leads.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?lead_page={{ leads.next_page_number }}">Next</a>
                </li>
            {% endif %}
        </ul>
    </nav>
</div>
    <!-- COMMUNICATIONS SECTION -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Communications</h5>
            <a class="btn btn-outline-primary btn-sm" href="{% url 'create-communication' %}">
                + New Communication
            </a>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Customer</th>
                            <th>Type</th>
                            <th>Note</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for com in communications %}
                        <tr>
                            <td>{{ com.id }}</td>
                            <td>{{ com.customer.first_name }} {{ com.customer.last_name }}</td>
                            <td>{{ com.type }}</td>
                            <td>{{ com.note }}</td>
                            <td>{{ com.date }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
<div class="card-footer">
    <nav>
        <ul class="pagination justify-content-center">
            {% if communications.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?comm_page={{ communications.previous_page_number }}">Previous</a>
                </li>
            {% endif %}
            <li class="page-item disabled">
                <span class="page-link">Page {{ communications.number }} of {{ communications.paginator.num_pages }}</span>
            </li>
            {% if communications.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?comm_page={{ communications.next_page_number }}">Next</a>
                </li>
            {% endif %}
        </ul>
    </nav>
</div>

    <!-- CHARTS SECTION -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    Lead Status Chart
                </div>
                <div class="card-body">
                    <canvas id="leadsChart" width="400" height="400"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    Communication Type Chart
                </div>
                <div class="card-body">
                    <canvas id="commChart" width="400" height="400"></canvas>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Lead chart
    const leadStatusLabels = {{ lead_status_labels|safe }};
    const leadStatusCounts = {{ lead_status_counts|safe }};

    const leadsCtx = document.getElementById('leadsChart').getContext('2d');
    new Chart(leadsCtx, {
        type: 'pie',
        data: {
            labels: leadStatusLabels,
            datasets: [{
                label: 'Lead Status',
                data: leadStatusCounts,
                backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6610f2']
            }]
        }
    });

    // Communication chart
    const commTypeLabels = {{ comm_type_labels|safe }};
    const commTypeCounts = {{ comm_type_counts|safe }};

    const commCtx = document.getElementById('commChart').getContext('2d');
    new Chart(commCtx, {
        type: 'bar',
        data: {
            labels: commTypeLabels,
            datasets: [{
                label: 'Communication Types',
                data: commTypeCounts,
                backgroundColor: ['#17a2b8', '#6f42c1', '#fd7e14']
            }]
        }
    });
</script>
{% endblock %}
